<link rel="import" href="../../bower_components/core-list/core-list.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html"/>

<polymer-element name="current-matches" vertical layout attributes="tournamentId tournamentName">
    <template>

        <h1>{{tournamentName}}</h1>

        <h2>Matches this round</h2>

        <table>
            <tr>
                <th>Hvit</th>
                <th></th>
                <th>Sort</th>
            </tr>
            <template repeat="{{data}}">
                <tr>
                    <td>
                        <paper-button
                                raisedButton
                                label="{{white.name}}"
                                on-tap="{{reportResult}}"
                                data-matchId="{{id}}"
                                data-result="{{'WHITE'}}"/>
                    </td>
                    <td>
                        <paper-button
                                raisedButton
                                label="vs"
                                on-tap="{{reportResult}}"
                                data-matchId="{{id}}"
                                data-result="{{'REMIS'}}"/>
                    </td>
                    <td>
                        <paper-button
                                raisedButton
                                label="{{black.name}}"
                                on-tap="{{reportResult}}"
                                data-matchId="{{id}}"
                                data-result="{{'BLACK'}}"/>
                    </td>
                <tr>
            </template>
        </table>

        <paper-button raisedButton label="Neste runde" on-tap="{{nextRound}}"></paper-button>


        <core-ajax
                auto="false"
                url="/rest/tournament/{{tournamentId}}"
                handleAs="json"
                id="fetchMatches"
                contentType="application/json"
                on-core-response="{{handleResponse}}">
        </core-ajax>


        <core-ajax
                auto="false"
                method="POST"
                url="/rest/match/{{id}}/report/{{result}}"
                handleAs="json"
                id="report_result"
                contentType="application/json"></core-ajax>

        <core-ajax
                auto="false"
                method="POST"
                url="/rest/tournament/{{tournamentId}}/next-round"
                handleAs="json"
                id="next_round"
                contentType="application/json"
                on-core-response="{{roundCreated}}"></core-ajax>

    </template>
    <script>
        Polymer('current-matches', {
            handleResponse: function (e) {
                console.log(e);
                if (e.detail.response.currentRound) {
                    this.data = e.detail.response.currentRound.matches;
                }
            },
            reportResult: function (e, detail, sender) {
                console.log(sender);
                console.log(sender.getAttribute("data-matchId"));
                console.log(sender.getAttribute("data-result"));
                this.id = sender.getAttribute("data-matchId");
                this.result = sender.getAttribute("data-result");

                this.$.report_result.go();
            },
            update: function () {
                this.$.fetchMatches.go();
            },
            nextRound: function () {
                this.$.next_round.go();
            },
            roundCreated: function () {
                this.$.fetchMatches.go();
            }

        });
    </script>

</polymer-element>